<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>Bç«™çƒ­é—¨è§†é¢‘æ˜Ÿå›¾</title>
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.164.0/build/three.module.js"
      }
    }
  </script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      /* é“¶æ²³æ¸å˜èƒŒæ™¯ */
      background: radial-gradient(ellipse at 60% 40%, #1a2a1a 60%, #0a1a1a 100%);
      min-height: 100vh;
    }
    #info {
      position: absolute;
      top: 18px; left: 18px;
      background: rgba(20,30,40,0.7);
      color: #fff;
      padding: 14px 20px;
      max-width: 340px;
      font-family: 'Segoe UI', Arial, sans-serif;
      font-size: 15px;
      border-radius: 12px;
      z-index: 10;
      box-shadow: 0 4px 24px 0 rgba(0,0,0,0.18);
      backdrop-filter: blur(2px);
      border: 1px solid rgba(80,200,255,0.08);
    }
    #blocker {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(10,20,40,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 28px;
      cursor: pointer;
      z-index: 20;
      letter-spacing: 2px;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    #crosshair {
      position: fixed; top: 50%; left: 50%;
      width: 18px; height: 18px;
      pointer-events: none;
      transform: translate(-50%, -50%);
      z-index: 30;
    }
    #crosshair:before, #crosshair:after {
      content: "";
      position: absolute;
      background: rgba(255,255,255,0.95);
      border-radius: 1px;
    }
    #crosshair:before {
      left: 50%; top: 0;
      width: 1px; height: 100%;
      transform: translateX(-50%);
    }
    #crosshair:after {
      top: 50%; left: 0;
      height: 1px; width: 100%;
      transform: translateY(-50%);
    }
    #helpBtn {
      position: absolute;
      bottom: 18px;
      left: 18px;
      background-color: rgba(20, 30, 40, 0.7);
      color: #fff;
      border: none;
      padding: 10px 18px;
      font-size: 17px;
      border-radius: 7px;
      cursor: pointer;
      z-index: 20;
      box-shadow: 0 2px 8px 0 rgba(0,0,0,0.18);
      transition: background 0.2s;
    }
    #helpBtn:hover {
      background-color: rgba(40, 80, 120, 0.8);
    }
    #helpModal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(10,20,40,0.8);
      justify-content: center;
      align-items: center;
      z-index: 30;
    }
    .modal-content {
      background-color: #1a2a1a;
      padding: 24px;
      border-radius: 14px;
      width: 92%;
      max-width: 420px;
      color: #fff;
      position: relative;
      box-shadow: 0 0 18px rgba(80,200,255,0.12);
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    .modal-content h2 {
      margin-top: 0;
      font-size: 22px;
      letter-spacing: 1px;
    }
    .modal-content ul {
      list-style-type: none;
      padding-left: 0;
    }
    .modal-content li {
      margin-bottom: 12px;
    }
    #closeModal {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 26px;
      color: #fff;
      cursor: pointer;
    }
    /* å¼€å±è¿›åº¦æ¡é®ç½© */
    #loadingOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(4,10,22,0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      transition: opacity 0.5s;
    }
    #loadingText {
      color: #fff;
      font-size: 20px;
      margin-bottom: 20px;
      font-family: sans-serif;
      letter-spacing: 2px;
    }
    #progressBar {
      width: 240px;
      height: 12px;
      background: #222;
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    #progressBarInner {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #00c3ff, #ffff1c);
      border-radius: 6px;
      transition: width 0.3s;
    }
    #progressPercent {
      color: #aaa;
      font-size: 14px;
      font-family: monospace;
      margin-bottom: 10px;
    }
    #minimap {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 260px;
      height: 260px;
      background: rgba(20,30,40,0.5);
      border-radius: 14px;
      box-shadow: 0 2px 16px 0 rgba(0,0,0,0.18);
      border: 2px solid rgba(200,220,255,0.18);
      z-index: 50;
      pointer-events: none;
      backdrop-filter: blur(2px);
    }
    /* æ“ä½œæŒ‰é’®è¯´æ˜æ ·å¼ */
    #controlsBar {
      position: fixed;
      left: 50%;
      bottom: 32px;
      transform: translateX(-50%);
      display: flex;
      align-items: flex-end;
      gap: 48px;
      z-index: 100;
      user-select: none;
      pointer-events: none;
    }
    .controls-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .controls-keys {
      display: flex;
      gap: 4px;
      margin-bottom: 2px;
    }
    .keycap {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 32px;
      height: 32px;
      background: rgba(40,50,60,0.7);
      color: #E2FF02;
      font-size: 18px;
      font-family: 'Segoe UI', Arial, sans-serif;
      border-radius: 8px;
      margin: 0 2px;
      box-shadow: 0 2px 8px 0 rgba(0,0,0,0.12);
      border: 1.5px solid rgba(120,140,180,0.13);
      font-weight: 500;
      pointer-events: none;
    }
    .keycap.big {
      min-width: 54px;
      font-size: 17px;
    }
    .controls-label {
      color: #bfc9d8;
      font-size: 15px;
      margin-top: 2px;
      letter-spacing: 0.5px;
    }
    .mousecap {
      width: 28px;
      height: 28px;
      border: 2px solid #e3e8ef;
      border-radius: 50%;
      display: inline-block;
      margin: 0 2px;
      position: relative;
      background: none;
    }
    .mousecap:after {
      content: '';
      position: absolute;
      left: 50%; top: 50%;
      width: 6px; height: 6px;
      background: #e3e8ef;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      opacity: 0.7;
    }
  </style>
</head>
<body>

<div id="info">ç‚¹å‡»å±å¹•è¿›å…¥æ§åˆ¶ï¼ŒW/A/S/D/R/F/Shift ç§»åŠ¨ï¼Œé¼ æ ‡çœ‹ï¼ŒEsc è§£é”ã€‚å±å¹•ä¸­å¿ƒæ‚¬åœé«˜äº®ï¼ŒQ è·³è½¬è§†é¢‘ã€‚</div>
<div id="blocker">ç‚¹å‡»è¿›å…¥ 3D æ˜Ÿå›¾</div>
<div id="crosshair"></div>

<!-- Help Button -->
<button id="helpBtn">â“ ä½¿ç”¨å¸®åŠ©</button>

<!-- Modal å¼¹çª— -->
<div id="helpModal">
  <div class="modal-content">
    <span id="closeModal">&times;</span>
    <h2>3D æ˜Ÿå›¾ä½¿ç”¨è¯´æ˜</h2>
    <ul>
      <li><strong>ç‚¹å‡»å±å¹•ï¼š</strong>è¿›å…¥æ§åˆ¶æ¨¡å¼</li>
      <li><strong>W/A/S/Dï¼š</strong>å‰åå·¦å³ç§»åŠ¨</li>
      <li><strong>R/Fï¼š</strong>ä¸Šä¸‹ç§»åŠ¨</li>
      <li><strong>Shiftï¼š</strong>å¼€å¯åŠ é€Ÿï¼ˆè·³è·ƒå¼å‰è¿›ï¼‰</li>
      <li><strong>é¼ æ ‡ç§»åŠ¨ï¼š</strong>æ”¹å˜è§†è§’æ–¹å‘</li>
      <li><strong>Q é”®ï¼š</strong>æ‚¬åœé«˜äº®çš„æ˜Ÿç‚¹æ—¶æŒ‰ Q æ‰“å¼€è§†é¢‘é“¾æ¥ï¼ˆæ–°æ ‡ç­¾é¡µï¼‰</li>
      <li><strong>E é”®ï¼š</strong>æ‚¬åœé«˜äº®çš„æ˜Ÿç‚¹æ—¶æŒ‰ E åœ¨é¡µé¢å¼¹çª—ä¸­æ’­æ”¾è§†é¢‘ï¼Œå¼¹çª—æ—¶æ˜Ÿå›¾æš‚åœï¼ŒE æˆ–ç‚¹å‡»å¼¹çª—å¤–å…³é—­</li>
      <li><strong>Escï¼š</strong>é€€å‡ºæ§åˆ¶æ¨¡å¼</li>
    </ul>
  </div>
</div>

<!-- å¼€å±è¿›åº¦æ¡é®ç½© -->
<div id="loadingOverlay">
  <div id="loadingText">æ•°æ®åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...</div>
  <div id="progressBar"><div id="progressBarInner"></div></div>
  <div id="progressPercent">0%</div>
</div>

<canvas id="minimap" width="260" height="260"></canvas>

<div id="videoModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(10,20,40,0.85);z-index:1000;align-items:center;justify-content:center;">
  <div style="position:relative;width:70vw;height:70vh;max-width:900px;max-height:600px;background:#111;border-radius:14px;box-shadow:0 8px 32px #000;display:flex;align-items:center;justify-content:center;">
    <span id="closeVideoModal" style="position:absolute;top:10px;right:18px;font-size:32px;color:#fff;cursor:pointer;z-index:10;">&times;</span>
    <iframe id="videoIframe" src="" frameborder="0" allowfullscreen sandbox="allow-scripts allow-same-origin allow-popups" style="width:100%;height:100%;border-radius:12px;"></iframe>
  </div>
</div>

<!-- æ“ä½œæŒ‰é’®è¯´æ˜æ  -->
<div id="controlsBar">
  <div class="controls-group">
    <div class="controls-keys">
      <span class="keycap">W</span>
    </div>
    <div class="controls-keys">
      <span class="keycap">A</span>
      <span class="keycap">S</span>
      <span class="keycap">D</span>
    </div>
    <div class="controls-label">Move</div>
  </div>
  <div class="controls-group">
    <span class="mousecap"></span>
    <div class="controls-label">Look</div>
  </div>
  <div class="controls-group">
    <span class="keycap big">Shift</span>
    <div class="controls-label">Boost</div>
  </div>
  <div class="controls-group">
    <span class="keycap big">Q</span>
    <div class="controls-label">Goto Video Url</div>
  </div>
  <div class="controls-group">
    <span class="keycap big">E</span>
    <div class="controls-label">Open Video</div>
  </div>

</div>

<!-- é¡µé¢å³ä¸‹è§’æ˜¾ç¤ºä¸‰ç»´åæ ‡ -->
<div id="coordDisplay" style="position:fixed;right:24px;bottom:24px;z-index:120;background:rgba(20,30,40,0.7);color:#E2FF02;padding:10px 18px;border-radius:10px;font-size:15px;font-family:monospace;box-shadow:0 2px 8px 0 rgba(0,0,0,0.13);user-select:text;pointer-events:auto;">
  ä½ç½®:  x: 0.00  y: 0.00  z: 0.00
</div>

<script type="module">
import * as THREE from "three";
import { PointerLockControls } from "https://unpkg.com/three@0.164.0/examples/jsm/controls/PointerLockControls.js";

let camera, scene, renderer, controls, raycaster;
let points, highlightRing = null;
let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false, moveUp = false, moveDown = false, isWarp = false;
let velocity = new THREE.Vector3();
let prevTime = performance.now();
const speed = 6, warpSpeed = 32;
const infoDiv = document.getElementById('info');
const blocker = document.getElementById('blocker');

// è·å–æ¨¡æ€æ¡†å…ƒç´ 
const helpBtn = document.getElementById('helpBtn');
const helpModal = document.getElementById('helpModal');
const closeModal = document.getElementById('closeModal');

// è¿›åº¦æ¡å…ƒç´ 
const loadingOverlay = document.getElementById('loadingOverlay');
const progressBarInner = document.getElementById('progressBarInner');
const progressPercent = document.getElementById('progressPercent');

// è§†é¢‘å¼¹çª—ç›¸å…³
const videoModal = document.getElementById('videoModal');
const videoIframe = document.getElementById('videoIframe');
const closeVideoModal = document.getElementById('closeVideoModal');

let controlsLockedBeforeModal = false;
let starMapPaused = false;
let escLocked = false;

// æ–°å¢ï¼šè®°å½•å¼¹çª—å‰çš„ç›¸æœºä½ç½®å’Œæœå‘
let savedPosition = null;
let savedRotation = null;

// è®¿é—®è¿‡çš„èŠ‚ç‚¹ç´¢å¼•é›†åˆ
const visitedNodeSet = new Set();

// æŒ‰é”®ç¼“å­˜
let keyStateCache = {};

let lastHighlightIdx = null;
let highlightLine = null;

// æ¨¡æ‹Ÿè¿›åº¦æ¡ï¼ˆfetchä¸æ”¯æŒåŸç”Ÿè¿›åº¦ï¼Œå®é™…å¯ç”¨XHRæˆ–fetch+streamä¼˜åŒ–ï¼‰
function setProgress(p) {
  progressBarInner.style.width = `${p}%`;
  progressPercent.textContent = `${p}%`;
}

setProgress(10);
fetch('data.json')
  .then(res => {
    setProgress(30);
    return res.json();
  })
  .then(pointData => {
    setProgress(60);
    setTimeout(() => {
      init(pointData);
      setProgress(90);
      setTimeout(() => {
        setProgress(100);
        setTimeout(() => {
          loadingOverlay.style.opacity = 0;
          setTimeout(() => loadingOverlay.style.display = 'none', 500);
        }, 400);
      }, 200);
    }, 200);
    animate();
  });

function findDenseRegion(pointData, gridSize = 0.1) {
  const grid = new Map();

  for (const point of pointData) {
    const pos = point.position;
    const key = [
      Math.floor(pos[0] / gridSize),
      Math.floor(pos[1] / gridSize),
      Math.floor(pos[2] / gridSize)
    ].join(',');

    if (!grid.has(key)) grid.set(key, []);
    grid.get(key).push(pos);
  }

  let maxCount = 0;
  let denseCenter = [0, 0, 0];

  for (const [key, points] of grid.entries()) {
    if (points.length > maxCount) {
      maxCount = points.length;
      const sum = [0, 0, 0];
      for (const p of points) {
        sum[0] += p[0];
        sum[1] += p[1];
        sum[2] += p[2];
      }
      denseCenter = [
        sum[0] / points.length,
        sum[1] / points.length,
        sum[2] / points.length
      ];
    }
  }

  return denseCenter;
}

// ç‚¹è´´å›¾ç”Ÿæˆå‡½æ•°
function createGlowTexture() {
  const size = 64;
  const canvas = document.createElement('canvas');
  canvas.width = canvas.height = size;
  const ctx = canvas.getContext('2d');
  const gradient = ctx.createRadialGradient(size/2, size/2, 2, size/2, size/2, size/2);
  gradient.addColorStop(0, 'rgba(255,255,200,1)');
  gradient.addColorStop(0.2, 'rgba(180,255,100,0.9)');
  gradient.addColorStop(0.5, 'rgba(80,255,80,0.7)');
  gradient.addColorStop(1, 'rgba(0,0,0,0)');
  ctx.fillStyle = gradient;
  ctx.fillRect(0,0,size,size);
  return new THREE.CanvasTexture(canvas);
}

let minimap, minimapCtx;
let allPositions = null, allUserDatas = null;

function init(pointData) {
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0a1a1a);
  scene.fog = new THREE.Fog(0x0a1a1a, 2, 30);
  camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.01, 100);

  // å®šä½åˆ°æœ€å¯†é›†åŒºåŸŸ
  const center = findDenseRegion(pointData);
  camera.position.set(center[0] + 0.7, center[1]-2, center[2] - 1);

  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  controls = new PointerLockControls(camera, document.body);
  controls.getObject().lookAt(center[0], center[1], center[2]);
  scene.add(controls.getObject());

  blocker.addEventListener('click', () => controls.lock());
  controls.addEventListener('lock', () => blocker.style.display = 'none');
  controls.addEventListener('unlock', () => blocker.style.display = 'flex');

  // ç”¨THREE.Pointsæ¸²æŸ“æ‰€æœ‰èŠ‚ç‚¹
  const positions = [];
  const userDatas = [];
  const scale = 1.7; // ç¨€ç–ç³»æ•°
  pointData.forEach((d, idx) => {
    positions.push(d.position[0] * scale, d.position[1] * scale, d.position[2] * scale);
    d._globalIndex = idx;
    userDatas.push(d);
  });
  allPositions = new Float32Array(positions);
  allUserDatas = userDatas;
  const geometry = new THREE.BufferGeometry();
  geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
  geometry.userDatas = userDatas;
  const material = new THREE.PointsMaterial({
    color: 0xE2FF02,
    size: 0.018,
    sizeAttenuation: true,
    transparent: false,
    opacity: 1,
    depthWrite: true,
    blending: THREE.AdditiveBlending,
    map: createGlowTexture(),
    alphaTest: 0.01
  });
  points = new THREE.Points(geometry, material);
  scene.add(points);

  scene.add(new THREE.AmbientLight(0xffffff, 0.6));
  const spot = new THREE.SpotLight(0xffffff, 0.8);
  spot.position.set(3, 3, 3);
  scene.add(spot);

  raycaster = new THREE.Raycaster();
  raycaster.params.Points.threshold = 0.05;

  window.addEventListener('resize', onWindowResize);
  window.addEventListener('keydown', onKey);
  window.addEventListener('keyup', onKey);

  // æ¨¡æ€æ¡†äº¤äº’
  helpBtn.addEventListener('click', () => {
    escLocked = false;
    starMapPaused = false;
  });

  closeModal.addEventListener('click', () => {
    helpModal.style.display = 'none';
  });

  helpModal.addEventListener('click', (e) => {
    if (e.target === helpModal) {
      helpModal.style.display = 'none';
    }
  });

  // é¼ æ ‡æ“ä½œå¢å¼º
  window.addEventListener('mousedown', (e) => {
    if (starMapPaused || escLocked) return;
  });
  window.addEventListener('mouseup', (e) => {
    if (starMapPaused || escLocked) return;
  });
  window.addEventListener('contextmenu', e => e.preventDefault()); // ç¦æ­¢å³é”®èœå•
  window.addEventListener('auxclick', (e) => {
    if (e.button === 1 && highlightRing && !escLocked) {
      const url = highlightRing.userData && highlightRing.userData["è§†é¢‘é“¾æ¥"];
      if (url) window.open(url, '_blank');
    }
  });

  minimap = document.getElementById('minimap');
  minimapCtx = minimap.getContext('2d');
}

function onWindowResize() {
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

function onKey(event) {
  const down = (event.type === 'keydown');
  // ç¼“å­˜æ‰€æœ‰æŒ‰é”®çŠ¶æ€
  keyStateCache[event.code] = down;
  
  // åœ¨escLockedçŠ¶æ€ä¸‹ï¼Œåªå…è®¸Escapeé”®æ“ä½œ
  if (escLocked && event.code !== 'Escape') return;
  
  // åœ¨starMapPausedçŠ¶æ€ä¸‹ï¼Œåªå…è®¸Eé”®æ“ä½œ
  if (starMapPaused && event.code !== 'KeyE') return;
  
  switch (event.code) {
    case 'KeyW': moveForward = down; break;
    case 'KeyS': moveBackward = down; break;
    case 'KeyA': moveLeft = down; break;
    case 'KeyD': moveRight = down; break;
    case 'KeyR': moveUp = down; break;
    case 'KeyF': moveDown = down; break;
    case 'ShiftLeft':
    case 'ShiftRight': isWarp = down; break;
    case 'KeyQ':
      if (down && highlightRing && !escLocked) {
        const url = highlightRing.userData && highlightRing.userData["è§†é¢‘é“¾æ¥"];
        if (url) {
          window.open(url, '_blank');
          // ç¡®ä¿åœ¨æ‰“å¼€æ–°æ ‡ç­¾é¡µåé‡ç½®æ‰€æœ‰çŠ¶æ€
          moveForward = false;
          moveBackward = false;
          moveLeft = false;
          moveRight = false;
          moveUp = false;
          moveDown = false;
          isWarp = false;
        }
      }
      break;
    case 'KeyE':
      if (down) {
        if (!starMapPaused && highlightRing) {
          const url = highlightRing.userData && highlightRing.userData["è§†é¢‘é“¾æ¥"];
          if (url) openVideoPopup(url);
        } else if (starMapPaused) {
          closeVideoPopup();
        }
      }
      break;
    case 'Escape':
      if (!escLocked) {
        escLocked = true;
        starMapPaused = true;
        document.body.style.cursor = 'auto';
        document.getElementById('helpBtn').style.display = '';
        // é‡ç½®æ‰€æœ‰ç§»åŠ¨çŠ¶æ€
        moveForward = false;
        moveBackward = false;
        moveLeft = false;
        moveRight = false;
        moveUp = false;
        moveDown = false;
        isWarp = false;
      }
      break;
  }
}

function highlightSphereMesh(index) {
  if (highlightRing) {
    scene.remove(highlightRing);
    highlightRing.geometry.dispose();
    highlightRing.material.dispose();
    highlightRing = null;
  }
  // è·å–ç‚¹çš„åæ ‡
  const posArr = points.geometry.attributes.position.array;
  const x = posArr[index * 3];
  const y = posArr[index * 3 + 1];
  const z = posArr[index * 3 + 2];
  // è·å–ç‚¹çš„userData
  const d = points.geometry.userDatas[index];

  // å›ºå®šé«˜äº®ç¯å¤§å°ï¼Œç™½è‰²å‘å…‰æè´¨
  highlightRing = new THREE.Mesh(
    new THREE.RingGeometry(0.01, 0.014, 32),
    new THREE.MeshBasicMaterial({
      color: 0xffffff,
      transparent: true,
      opacity: 1,
      blending: THREE.AdditiveBlending,
      depthTest: false
    })
  );
  highlightRing.position.set(x, y, z);
  highlightRing.lookAt(camera.position);
  highlightRing.renderOrder = 999;
  highlightRing.userData = d;
  scene.add(highlightRing);

  // å±•ç¤ºä¿¡æ¯
  // ä¼˜åŒ–æè¿°çœç•¥å·å’Œæ¢è¡Œ
  let desc = d.description || '';
  let maxLen = 60;
  if (desc.length > maxLen) desc = desc.slice(0, maxLen) + '...';
  infoDiv.innerHTML = `
    <b>çƒ­é—¨æœŸæ•°ï¼š</b>${d.æœŸæ•°}<br>
    <b>æ ‡é¢˜ï¼š</b>${d.title}<br>
    <b>æè¿°ï¼š</b><span style="display:inline-block;max-width:300px;word-break:break-all;overflow:hidden;text-overflow:ellipsis;white-space:pre-line;vertical-align:top;">${desc}</span><br>
    <b>UPä¸»ï¼š</b>${d.UPä¸»}<br>
    <b>åˆ†ç±»ï¼š</b>${d.åˆ†ç±»} - ${d.å­åˆ†ç±»}<br>
    <b>ğŸ‘ï¼š</b>${d.ç‚¹èµæ•°} &nbsp; <b>æ”¶è—ï¼š</b>${d.æ”¶è—æ•°}<br>
    <b>ğŸ’¬ï¼š</b>${d.è¯„è®ºæ•°}<br>
    <img src="${d.å°é¢å›¾ç‰‡}" referrerpolicy="no-referrer" style="width: 100%; max-height: 220px; object-fit: cover; border-radius: 4px;" />`;
}

function renderMinimap() {
  if (!minimapCtx || !allPositions) return;
  const w = minimap.width, h = minimap.height;
  minimapCtx.clearRect(0, 0, w, h);
  // èƒŒæ™¯æ¸å˜
  const bgGrad = minimapCtx.createLinearGradient(0, 0, w, h);
  bgGrad.addColorStop(0, '#1a2a1a');
  bgGrad.addColorStop(1, '#0a1a1a');
  minimapCtx.fillStyle = bgGrad;
  minimapCtx.fillRect(0, 0, w, h);
  // è®¡ç®—åŒ…å›´ç›’
  let minX=Infinity, maxX=-Infinity, minY=Infinity, maxY=-Infinity;
  for (let i=0; i<allPositions.length; i+=3) {
    minX = Math.min(minX, allPositions[i]);
    maxX = Math.max(maxX, allPositions[i]);
    minY = Math.min(minY, allPositions[i+1]);
    maxY = Math.max(maxY, allPositions[i+1]);
  }
  const pad = 0.1 * Math.max(maxX-minX, maxY-minY);
  minX -= pad; maxX += pad; minY -= pad; maxY += pad;
  // ç”»æ‰€æœ‰ç‚¹
  let edgeFlags = {left:false,right:false,top:false,bottom:false};
  for (let i=0; i<allPositions.length; i+=3) {
    const x = allPositions[i], y = allPositions[i+1];
    const px = ((x-minX)/(maxX-minX))*w;
    const py = h-((y-minY)/(maxY-minY))*h;
    minimapCtx.beginPath();
    minimapCtx.arc(px, py, 4, 0, 2*Math.PI);
    minimapCtx.fillStyle = '#E2FF02';
    minimapCtx.globalAlpha = 0.85;
    minimapCtx.fill();
    minimapCtx.globalAlpha = 1;
    // è¾¹ç¼˜æ£€æµ‹
    if (px < 10) edgeFlags.left = true;
    if (px > w-10) edgeFlags.right = true;
    if (py < 10) edgeFlags.top = true;
    if (py > h-10) edgeFlags.bottom = true;
  }
  // ç”»ç›¸æœºæœå‘
  const cx = ((camera.position.x-minX)/(maxX-minX))*w;
  const cy = h-((camera.position.y-minY)/(maxY-minY))*h;
  minimapCtx.save();
  minimapCtx.translate(cx, cy);
  minimapCtx.strokeStyle = '#fff';
  minimapCtx.lineWidth = 2.5;
  minimapCtx.beginPath();
  minimapCtx.arc(0, 0, 10, 0, 2*Math.PI);
  minimapCtx.stroke();
  // æœå‘ç®­å¤´
  const dir = new THREE.Vector3();
  camera.getWorldDirection(dir);
  const angle = Math.atan2(dir.y, dir.x);
  minimapCtx.rotate(angle);
  minimapCtx.beginPath();
  minimapCtx.moveTo(0, 0);
  minimapCtx.lineTo(18, 0);
  minimapCtx.lineTo(12, -6);
  minimapCtx.moveTo(18, 0);
  minimapCtx.lineTo(12, 6);
  minimapCtx.stroke();
  minimapCtx.restore();
  // è¾¹ç¼˜æŒ‡ç¤ºç®­å¤´
  minimapCtx.save();
  minimapCtx.strokeStyle = '#E2FF02';
  minimapCtx.fillStyle = '#E2FF02';
  minimapCtx.globalAlpha = 0.7;
  if (edgeFlags.left) {
    minimapCtx.beginPath();
    minimapCtx.moveTo(8, h/2);
    minimapCtx.lineTo(18, h/2-8);
    minimapCtx.lineTo(18, h/2+8);
    minimapCtx.closePath();
    minimapCtx.fill();
  }
  if (edgeFlags.right) {
    minimapCtx.beginPath();
    minimapCtx.moveTo(w-8, h/2);
    minimapCtx.lineTo(w-18, h/2-8);
    minimapCtx.lineTo(w-18, h/2+8);
    minimapCtx.closePath();
    minimapCtx.fill();
  }
  if (edgeFlags.top) {
    minimapCtx.beginPath();
    minimapCtx.moveTo(w/2, 8);
    minimapCtx.lineTo(w/2-8, 18);
    minimapCtx.lineTo(w/2+8, 18);
    minimapCtx.closePath();
    minimapCtx.fill();
  }
  if (edgeFlags.bottom) {
    minimapCtx.beginPath();
    minimapCtx.moveTo(w/2, h-8);
    minimapCtx.lineTo(w/2-8, h-18);
    minimapCtx.lineTo(w/2+8, h-18);
    minimapCtx.closePath();
    minimapCtx.fill();
  }
  minimapCtx.restore();
}

function updateVisiblePoints() {
  if (!allPositions || !allUserDatas || !points) return;
  const maxRenderDist = 30; // å¯è°ƒ
  const camPos = camera.position;
  const visiblePositions = [];
  const visibleUserDatas = [];
  const colors = [];
  for (let i = 0; i < allPositions.length; i += 3) {
    const dx = allPositions[i] - camPos.x;
    const dy = allPositions[i+1] - camPos.y;
    const dz = allPositions[i+2] - camPos.z;
    if (dx*dx + dy*dy + dz*dz < maxRenderDist*maxRenderDist) {
      visiblePositions.push(allPositions[i], allPositions[i+1], allPositions[i+2]);
      visibleUserDatas.push(allUserDatas[i/3]);
      // æ‰€æœ‰ç‚¹éƒ½ä¸ºè§å…‰ç»¿#E2FF02
      colors.push(0xE2FF02, 0xE2FF02, 0xE2FF02);
    }
  }
  // æ›´æ–°geometry
  const newAttr = new THREE.Float32BufferAttribute(visiblePositions, 3);
  points.geometry.setAttribute('position', newAttr);
  points.geometry.userDatas = visibleUserDatas;
  points.geometry.setDrawRange(0, visiblePositions.length/3);
  points.geometry.attributes.position.needsUpdate = true;
  // è®¾ç½®é¢œè‰²å±æ€§
  if (colors.length > 0) {
    const colorAttr = new THREE.Float32BufferAttribute(colors, 3);
    points.geometry.setAttribute('color', colorAttr);
    points.material.vertexColors = true;
    points.material.color.set(0xE2FF02);
  }
}

function getEmbedUrl(url) {
  // Bç«™æ™®é€šè§†é¢‘é¡µè½¬iframeåµŒå…¥åœ°å€
  const bvMatch = url.match(/bilibili\.com\/video\/(BV[\w]+)/i);
  if (bvMatch) {
    return `https://player.bilibili.com/player.html?bvid=${bvMatch[1]}&autoplay=1&high_quality=1`;
  }
  // Bç«™ä¸“æ 
  const cvMatch = url.match(/bilibili\.com\/read\/(cv\d+)/i);
  if (cvMatch) {
    return `https://www.bilibili.com/read/${cvMatch[1]}`;
  }
  // b23.tvçŸ­é“¾ç›´æ¥å†…åµŒ
  if (/b23\.tv/.test(url)) {
    return url;
  }
  // å…¶ä»–å¹³å°å¯æ‰©å±•ï¼Œébilibiliå¤–é“¾ç›´æ¥è¿”å›åŸurlï¼ˆiframeæœ‰sandboxä¿æŠ¤ï¼‰
  return url;
}

function openVideoPopup(url) {
  // è®°å½•å¼¹çª—å‰çš„ç›¸æœºä½ç½®å’Œæœå‘
  if (controls && controls.getObject) {
    const obj = controls.getObject();
    savedPosition = obj.position.clone();
    // å¼¹çª—æ—¶ç«‹å³æ¸…é›¶é€Ÿåº¦
    velocity.set(0, 0, 0);
  }
  starMapPaused = true;
  controlsLockedBeforeModal = controls.isLocked;
  if (controlsLockedBeforeModal) controls.unlock();
  blocker.style.display = 'none';
  videoIframe.src = getEmbedUrl(url);
  videoModal.style.display = 'flex';
  document.body.style.cursor = 'auto';
  // é‡ç½®æ‰€æœ‰ç§»åŠ¨çŠ¶æ€
  moveForward = false;
  moveBackward = false;
  moveLeft = false;
  moveRight = false;
  moveUp = false;
  moveDown = false;
  isWarp = false;
  setTimeout(() => videoIframe.focus(), 100);
}

function closeVideoPopup() {
  videoModal.style.display = 'none';
  videoIframe.src = '';
  starMapPaused = false;
  document.body.style.cursor = '';
  // åªæ¢å¤å¼¹çª—å‰çš„ç›¸æœºä½ç½®ï¼Œä¸æ¢å¤rotation
  if (controls && controls.getObject && savedPosition) {
    const obj = controls.getObject();
    obj.position.copy(savedPosition);
    // æ¢å¤åå†æ¬¡æ¸…é›¶é€Ÿåº¦
    velocity.set(0, 0, 0);
  }
  // å¦‚æœä¹‹å‰æ˜¯é”å®šçŠ¶æ€ï¼Œé‡æ–°é”å®šæ§åˆ¶
  if (controlsLockedBeforeModal) {
    controls.lock();
  }
  // é‡ç½®æ‰€æœ‰ç§»åŠ¨çŠ¶æ€
  moveForward = false;
  moveBackward = false;
  moveLeft = false;
  moveRight = false;
  moveUp = false;
  moveDown = false;
  isWarp = false;
}

function updateCoordDisplay() {
  const coordDiv = document.getElementById('coordDisplay');
  if (camera && camera.position) {
    const p = camera.position;
    coordDiv.textContent = `ä½ç½®:  x: ${p.x.toFixed(2)}  y: ${p.y.toFixed(2)}  z: ${p.z.toFixed(2)}`;
  } else {
    coordDiv.textContent = 'ä½ç½®:  x: 0.00  y: 0.00  z: 0.00';
  }
}

function animate() {
  requestAnimationFrame(animate);
  // åˆ¤ç©ºä¿æŠ¤ï¼Œé˜²æ­¢ raycaster/points æœªåˆå§‹åŒ–æ—¶æŠ¥é”™
  if (!raycaster || !points) {
    if (renderer && scene && camera) {
      renderer.render(scene, camera);
    }
    renderMinimap();
    updateCoordDisplay();
    infoDiv.innerHTML = 'ç‚¹å‡»å±å¹•è¿›å…¥æ§åˆ¶ï¼ŒW/A/S/D/R/F/Shift ç§»åŠ¨ï¼Œé¼ æ ‡çœ‹ï¼ŒEsc è§£é”ã€‚å±å¹•ä¸­å¿ƒæ‚¬åœé«˜äº®ï¼ŒQ è·³è½¬è§†é¢‘ã€‚';
    return;
  }
  // escLocked æ—¶ç¦æ­¢ä¸€åˆ‡ç§»åŠ¨å’Œæ“ä½œï¼Œåªæ¸²æŸ“
  if (escLocked) {
    renderer.render(scene, camera);
    renderMinimap();
    updateCoordDisplay();
    return;
  }
  if (starMapPaused) {
    velocity.set(0, 0, 0);
    renderer.render(scene, camera);
    renderMinimap();
    updateCoordDisplay();
    return;
  }
  updateVisiblePoints();
  // ä¼˜åŒ–å‡†å¿ƒé€‰ä¸­é€»è¾‘ï¼šåªé«˜äº®å‡†å¿ƒæ–¹å‘ä¸Šè·ç¦»ç›¸æœºæœ€è¿‘çš„ç‚¹
  raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
  const intersects = raycaster.intersectObject(points, false);
  if (intersects.length > 0 && intersects[0].distance < 10) {
    highlightSphereMesh(intersects[0].index);
  } else {
    if (highlightRing) {
      scene.remove(highlightRing);
      highlightRing = null;
    }
    // æœªé€‰ä¸­ä»»ä½•ç‚¹æ—¶æ˜¾ç¤ºè¯´æ˜
    infoDiv.innerHTML = 'ç‚¹å‡»å±å¹•è¿›å…¥æ§åˆ¶ï¼ŒW/A/S/D/R/F/Shift ç§»åŠ¨ï¼Œé¼ æ ‡çœ‹ï¼ŒEsc è§£é”ã€‚å±å¹•ä¸­å¿ƒæ‚¬åœé«˜äº®ï¼ŒQ è·³è½¬è§†é¢‘ã€‚';
  }

  // FPSå¼ç§»åŠ¨
  const time = performance.now();
  const delta = (time - prevTime) / 1000;
  prevTime = time;

  velocity.x -= velocity.x * 10.0 * delta;
  velocity.y -= velocity.y * 10.0 * delta;
  velocity.z -= velocity.z * 10.0 * delta;

  // é¼ æ ‡å·¦å³é”®é•¿æŒ‰æ—¶é€Ÿåº¦ä¸shiftä¸€è‡´
  const actualSpeed = isWarp || moveForward || moveBackward ? warpSpeed : speed;

  const direction = new THREE.Vector3();
  camera.getWorldDirection(direction);
  direction.normalize();

  const right = new THREE.Vector3();
  right.crossVectors(camera.up, direction).normalize();

  const up = new THREE.Vector3();
  up.copy(camera.up).normalize();

  let moveDir = new THREE.Vector3();
  if (moveForward) moveDir.add(direction);
  if (moveBackward) moveDir.sub(direction);
  if (moveLeft) moveDir.add(right);
  if (moveRight) moveDir.sub(right);
  if (moveUp) moveDir.add(up);
  if (moveDown) moveDir.sub(up);

  if (!moveDir.equals(new THREE.Vector3())) {
    moveDir.normalize();
  }

  velocity.addScaledVector(moveDir, actualSpeed * delta);
  controls.getObject().position.add(velocity.clone().multiplyScalar(delta));

  renderMinimap();
  renderer.render(scene, camera);
  updateCoordDisplay();
}

videoModal.onclick = (e) => {
  if (e.target === videoModal) closeVideoPopup();
};

// ç›‘å¬é¼ æ ‡å·¦é”®/å¸®åŠ©æŒ‰é’®/æ˜Ÿå›¾ç‚¹å‡»æ—¶æ¢å¤æ‰€æœ‰æŒ‰é”®çŠ¶æ€
function restoreKeyStates() {
  if (escLocked) return; // åœ¨escLockedçŠ¶æ€ä¸‹ä¸æ¢å¤æŒ‰é”®çŠ¶æ€
  
  escLocked = false;
  starMapPaused = false;
  // æ¢å¤æ‰€æœ‰æŒ‰é”®çŠ¶æ€
  moveForward = !!keyStateCache['KeyW'];
  moveBackward = !!keyStateCache['KeyS'];
  moveLeft = !!keyStateCache['KeyA'];
  moveRight = !!keyStateCache['KeyD'];
  moveUp = !!keyStateCache['KeyR'];
  moveDown = !!keyStateCache['KeyF'];
  isWarp = !!keyStateCache['ShiftLeft'] || !!keyStateCache['ShiftRight'];
}

// é¼ æ ‡å·¦é”®ç‚¹å‡» blocker æ¢å¤
blocker.addEventListener('click', () => {
  if (escLocked) {
    escLocked = false;
    starMapPaused = false;
    controls.lock();
    // ç¡®ä¿æ‰€æœ‰ç§»åŠ¨çŠ¶æ€éƒ½è¢«é‡ç½®
    moveForward = false;
    moveBackward = false;
    moveLeft = false;
    moveRight = false;
    moveUp = false;
    moveDown = false;
    isWarp = false;
    // é‡ç½®é¼ æ ‡çŠ¶æ€
    document.body.style.cursor = '';
  } else {
    restoreKeyStates();
    // ç¡®ä¿ç‚¹å‡»æ—¶ä¸ä¼šè§¦å‘å‰è¿›
    moveForward = false;
    moveBackward = false;
  }
});

// å¸®åŠ©æŒ‰é’®ç‚¹å‡»æ¢å¤
helpBtn.addEventListener('click', () => {
  if (!escLocked) {
    helpModal.style.display = 'flex';
    // é‡ç½®æ‰€æœ‰ç§»åŠ¨çŠ¶æ€
    moveForward = false;
    moveBackward = false;
    moveLeft = false;
    moveRight = false;
    moveUp = false;
    moveDown = false;
    isWarp = false;
  }
});

// æ·»åŠ æ§åˆ¶é”å®š/è§£é”äº‹ä»¶ç›‘å¬
controls.addEventListener('lock', () => {
  blocker.style.display = 'none';
  document.body.style.cursor = '';
  // é‡ç½®æ‰€æœ‰ç§»åŠ¨çŠ¶æ€
  moveForward = false;
  moveBackward = false;
  moveLeft = false;
  moveRight = false;
  moveUp = false;
  moveDown = false;
  isWarp = false;
});

controls.addEventListener('unlock', () => {
  if (!starMapPaused) {
    blocker.style.display = 'flex';
    document.body.style.cursor = 'auto';
  }
  // é‡ç½®æ‰€æœ‰ç§»åŠ¨çŠ¶æ€
  moveForward = false;
  moveBackward = false;
  moveLeft = false;
  moveRight = false;
  moveUp = false;
  moveDown = false;
  isWarp = false;
});

// ä¿®æ”¹å¸®åŠ©æ¨¡æ€æ¡†ç‚¹å‡»äº‹ä»¶
helpModal.addEventListener('click', (e) => {
  if (e.target === helpModal) {
    helpModal.style.display = 'none';
    // é‡ç½®æ‰€æœ‰ç§»åŠ¨çŠ¶æ€
    moveForward = false;
    moveBackward = false;
    moveLeft = false;
    moveRight = false;
    moveUp = false;
    moveDown = false;
    isWarp = false;
  }
});

// ä¿®æ”¹å…³é—­å¸®åŠ©æ¨¡æ€æ¡†äº‹ä»¶
closeModal.addEventListener('click', () => {
  helpModal.style.display = 'none';
  // é‡ç½®æ‰€æœ‰ç§»åŠ¨çŠ¶æ€
  moveForward = false;
  moveBackward = false;
  moveLeft = false;
  moveRight = false;
  moveUp = false;
  moveDown = false;
  isWarp = false;
});
</script>
</body>
</html>