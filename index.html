<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>3D è§†é¢‘æ˜Ÿå›¾ï¼ˆä¿®æ”¹é«˜äº®ï¼‰</title>
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.164.0/build/three.module.js"
      }
    }
  </script>
  <style>
    body { margin: 0; overflow: hidden; background: #000; }
    #info {
      position: absolute;
      top: 10px; left: 10px;
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 10px;
      max-width: 300px;
      font-family: sans-serif;
      font-size: 14px;
      border-radius: 8px;
      z-index: 10;
    }
    #blocker {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      cursor: pointer;
      z-index: 20;
    }
    #crosshair {
      position: fixed; top: 50%; left: 50%;
      width: 24px; height: 24px;
      pointer-events: none;
      transform: translate(-50%, -50%);
      z-index: 30;
    }
    #crosshair:before, #crosshair:after {
      content: ""; position: absolute;
      background: rgba(255,255,255,0.8);
      border-radius: 2px;
    }
    #crosshair:before {
      left: 50%; top: 0;
      width: 2px; height: 100%;
      transform: translateX(-50%);
    }
    #crosshair:after {
      top: 50%; left: 0;
      height: 2px; width: 100%;
      transform: translateY(-50%);
    }

    /* Help Button */
    #helpBtn {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background-color: rgba(0, 0, 0, 0.6);
      color: white;
      border: none;
      padding: 8px 12px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      z-index: 20;
    }

    /* Modal Styles */
    #helpModal {
      display: none; /* é»˜è®¤éšè— */
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
      z-index: 30;
    }

    .modal-content {
      background-color: #1a1a1a;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      color: white;
      position: relative;
      box-shadow: 0 0 10px rgba(255,255,255,0.2);
      font-family: sans-serif;
    }

    .modal-content h2 {
      margin-top: 0;
    }

    .modal-content ul {
      list-style-type: none;
      padding-left: 0;
    }

    .modal-content li {
      margin-bottom: 10px;
    }

    #closeModal {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div id="info">ç‚¹å‡»å±å¹•è¿›å…¥æ§åˆ¶ï¼ŒW/A/S/D/R/F/Shift ç§»åŠ¨ï¼Œé¼ æ ‡çœ‹ï¼ŒEsc è§£é”ã€‚å±å¹•ä¸­å¿ƒæ‚¬åœé«˜äº®ï¼ŒQ è·³è½¬è§†é¢‘ã€‚</div>
<div id="blocker">ç‚¹å‡»è¿›å…¥ 3D æ˜Ÿå›¾</div>
<div id="crosshair"></div>

<!-- Help Button -->
<button id="helpBtn">â“ ä½¿ç”¨å¸®åŠ©</button>

<!-- Modal å¼¹çª— -->
<div id="helpModal">
  <div class="modal-content">
    <span id="closeModal">&times;</span>
    <h2>3D æ˜Ÿå›¾ä½¿ç”¨è¯´æ˜</h2>
    <ul>
      <li><strong>ç‚¹å‡»å±å¹•ï¼š</strong>è¿›å…¥æ§åˆ¶æ¨¡å¼</li>
      <li><strong>W/A/S/Dï¼š</strong>å‰åå·¦å³ç§»åŠ¨</li>
      <li><strong>R/Fï¼š</strong>ä¸Šä¸‹ç§»åŠ¨</li>
      <li><strong>Shiftï¼š</strong>å¼€å¯åŠ é€Ÿï¼ˆè·³è·ƒå¼å‰è¿›ï¼‰</li>
      <li><strong>Q é”®ï¼š</strong>æ‚¬åœé«˜äº®çš„æ˜Ÿç‚¹æ—¶æŒ‰ Q æ‰“å¼€è§†é¢‘é“¾æ¥</li>
      <li><strong>é¼ æ ‡ç§»åŠ¨ï¼š</strong>æ”¹å˜è§†è§’æ–¹å‘</li>
      <li><strong>Escï¼š</strong>é€€å‡ºæ§åˆ¶æ¨¡å¼</li>
    </ul>
  </div>
</div>

<script type="module">
import * as THREE from "three";
import { PointerLockControls } from "https://unpkg.com/three@0.164.0/examples/jsm/controls/PointerLockControls.js";

let camera, scene, renderer, controls, raycaster;
let sphereGroup, highlightRing = null;
let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false, moveUp = false, moveDown = false, isWarp = false;
let velocity = new THREE.Vector3();
let prevTime = performance.now();
const speed = 1.5, warpSpeed = 8;
const infoDiv = document.getElementById('info');
const blocker = document.getElementById('blocker');

// è·å–æ¨¡æ€æ¡†å…ƒç´ 
const helpBtn = document.getElementById('helpBtn');
const helpModal = document.getElementById('helpModal');
const closeModal = document.getElementById('closeModal');

fetch('data.json').then(res => res.json()).then(pointData => {
  init(pointData);
  animate();
});

function findDenseRegion(pointData, gridSize = 0.1) {
  const grid = new Map();

  for (const point of pointData) {
    const pos = point.position;
    const key = [
      Math.floor(pos[0] / gridSize),
      Math.floor(pos[1] / gridSize),
      Math.floor(pos[2] / gridSize)
    ].join(',');

    if (!grid.has(key)) grid.set(key, []);
    grid.get(key).push(pos);
  }

  let maxCount = 0;
  let denseCenter = [0, 0, 0];

  for (const [key, points] of grid.entries()) {
    if (points.length > maxCount) {
      maxCount = points.length;
      const sum = [0, 0, 0];
      for (const p of points) {
        sum[0] += p[0];
        sum[1] += p[1];
        sum[2] += p[2];
      }
      denseCenter = [
        sum[0] / points.length,
        sum[1] / points.length,
        sum[2] / points.length
      ];
    }
  }

  return denseCenter;
}

function init(pointData) {
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.01, 100);

   // å®šä½åˆ°æœ€å¯†é›†åŒºåŸŸ
  const center = findDenseRegion(pointData);
  camera.position.set(center[0] + 0.5, center[1], center[2] + 0.5);


  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  controls = new PointerLockControls(camera, document.body);
  controls.getObject().lookAt(center[0], center[1], center[2]);
  scene.add(controls.getObject());

  blocker.addEventListener('click', () => controls.lock());
  controls.addEventListener('lock', () => blocker.style.display = 'none');
  controls.addEventListener('unlock', () => blocker.style.display = 'flex');

  // ç‚¹ä½œä¸º Mesh
  sphereGroup = new THREE.Group();
  pointData.forEach(d => {
    const m = new THREE.Mesh(
      new THREE.SphereGeometry(0.01, 12, 12),
      new THREE.MeshStandardMaterial({
        color: 0x00ff00, emissive: 0x00ff00, emissiveIntensity: 1, roughness: 0.5, metalness: 0.1
      })
    );
    m.position.set(...d.position);
    m.userData = d;
    sphereGroup.add(m);
  });
  scene.add(sphereGroup);

  scene.add(new THREE.AmbientLight(0xffffff, 0.6));
  const spot = new THREE.SpotLight(0xffffff, 0.8);
  spot.position.set(3, 3, 3);
  scene.add(spot);

  raycaster = new THREE.Raycaster();

  window.addEventListener('resize', onWindowResize);
  window.addEventListener('keydown', onKey);
  window.addEventListener('keyup', onKey);

  // æ¨¡æ€æ¡†äº¤äº’
  helpBtn.addEventListener('click', () => {
    helpModal.style.display = 'flex';
  });

  closeModal.addEventListener('click', () => {
    helpModal.style.display = 'none';
  });

  helpModal.addEventListener('click', (e) => {
    if (e.target === helpModal) {
      helpModal.style.display = 'none';
    }
  });
}

function onWindowResize() {
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

function onKey(event) {
  const down = (event.type === 'keydown');
  switch (event.code) {
    case 'KeyW': moveForward = down; break;
    case 'KeyS': moveBackward = down; break;
    case 'KeyA': moveLeft = down; break;
    case 'KeyD': moveRight = down; break;
    case 'KeyR': moveUp = down; break;
    case 'KeyF': moveDown = down; break;
    case 'ShiftLeft':
    case 'ShiftRight': isWarp = down; break;
    case 'KeyQ':
      if (highlightRing) {
        const url = highlightRing.userData["è§†é¢‘é“¾æ¥"];
        if (url) window.open(url, '_blank');
      }
      break;
  }
}

function highlightSphereMesh(sphere) {
  if (highlightRing) {
    scene.remove(highlightRing);
    highlightRing.geometry.dispose();
    highlightRing.material.dispose();
    highlightRing = null;
  }

  highlightRing = new THREE.Mesh(
    new THREE.RingGeometry(0.02, 0.025, 32),
    new THREE.MeshBasicMaterial({ color: 0xffffff, side: THREE.DoubleSide, transparent: true, opacity: 0.8 })
  );
  highlightRing.position.copy(sphere.position);
  highlightRing.lookAt(camera.position);
  highlightRing.userData = sphere.userData;
  scene.add(highlightRing);

  const d = sphere.userData;
  infoDiv.innerHTML = `
   <b>çƒ­é—¨æœŸæ•°ï¼š</b>${d.æœŸæ•°}<br>
   <b>æ ‡é¢˜ï¼š</b>${d.title}<br>
    <b>æè¿°ï¼š</b>${d.description}<br>
    <b>UPä¸»ï¼š</b>${d.UPä¸»}<br>
    <b>åˆ†ç±»ï¼š</b>${d.åˆ†ç±»} - ${d.å­åˆ†ç±»}<br>
    <b>ğŸ‘ï¼š</b>${d.ç‚¹èµæ•°} &nbsp; <b>æ”¶è—ï¼š</b>${d.æ”¶è—æ•°}<br>
    <b>ğŸ’¬ï¼š</b>${d.è¯„è®ºæ•°}<br>
    <img src="${d.å°é¢å›¾ç‰‡}" referrerpolicy="no-referrer" style="width: 100%; max-height: 220px; object-fit: cover; border-radius: 4px;" />
  `;
}

function animate() {
  requestAnimationFrame(animate);

  // å°„çº¿æ£€æµ‹ä¸­å¿ƒ
  raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
  const hits = raycaster.intersectObjects(sphereGroup.children);
  if (hits.length > 0) highlightSphereMesh(hits[0].object);
  else if (highlightRing) {
    scene.remove(highlightRing);
    highlightRing = null;
    infoDiv.innerHTML = '';
  }

  // FPSå¼ç§»åŠ¨
  const time = performance.now();
  const delta = (time - prevTime) / 1000;
  prevTime = time;

  velocity.x -= velocity.x * 10.0 * delta;
  velocity.y -= velocity.y * 10.0 * delta;
  velocity.z -= velocity.z * 10.0 * delta;

  const actualSpeed = isWarp ? warpSpeed : speed;

  const direction = new THREE.Vector3();
  camera.getWorldDirection(direction); // å®Œæ•´çš„æ–¹å‘ï¼ŒåŒ…å« y
  direction.normalize();

  const right = new THREE.Vector3();
  right.crossVectors(camera.up, direction).normalize(); // ç›¸æœºå³ä¾§æ–¹å‘

  const up = new THREE.Vector3();
  up.copy(camera.up).normalize(); // ç›¸æœºä¸Šæ–¹æ–¹å‘

  let moveDir = new THREE.Vector3();
  if (moveForward) moveDir.add(direction);   // å‰
  if (moveBackward) moveDir.sub(direction);  // å
  if (moveLeft) moveDir.sub(right);          // å·¦
  if (moveRight) moveDir.add(right);         // å³
  if (moveUp) moveDir.add(up);               // ä¸Š
  if (moveDown) moveDir.sub(up);             // ä¸‹

  if (!moveDir.equals(new THREE.Vector3())) {
    moveDir.normalize(); // é¿å…æ–œå‘ç§»åŠ¨è¿‡å¿«
  }

  velocity.addScaledVector(moveDir, actualSpeed * delta);
  controls.getObject().position.add(velocity.clone().multiplyScalar(delta));

  renderer.render(scene, camera);
}
</script>
</body>
</html>